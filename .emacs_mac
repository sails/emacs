(require 'package)
;; 国内的镜像
(setq package-archives '(("gnu"   . "http://elpa.emacs-china.org/gnu/")
                         ("melpa" . "http://elpa.emacs-china.org/melpa/")))
(package-initialize)

;; common lisp extensions一些额外的函数和宏
(require 'cl)

;; 启动自动检查安装配置
(defvar required-packages
  '(
    company
    yasnippet    
    flycheck
    flycheck-google-cpplint
    projectile
    xcscope
    magit
    autopair
    google-c-style
    ecb
    company-go
    org2blog
    zenburn-theme
    markdown-mode
    sr-speedbar
    swiper
    exec-path-from-shell
  ) "a list of packages to ensure are installed at launch.")

(defun packages-installed-p ()
  (loop for p in required-packages
        when (not (package-installed-p p)) do (return nil)
        finally (return t)))
;; 依次查检进行安装
(unless (packages-installed-p)
  (message "%s" "Emacs is now refreshing its package database...")
  (package-refresh-contents)
  (message "%s" " done.")
  ; install the missing packages
  (dolist (p required-packages)
    (when (not (package-installed-p p))
      (package-install p))))



;; ////////////////common setting/////////////////
;; key bindings,把meta映射成cmd键，但是不影响cmd+tab这样的系统快捷方式
(when (eq system-type 'darwin) ;; mac specific settings
  (setq mac-option-modifier 'alt)
  (setq mac-command-modifier 'meta)
  (global-set-key [kp-delete] 'delete-char) ;; sets fn-delete to be right-delete
  ;; 由于ls与linux中的不同，有些插件可能会报错
  (require 'ls-lisp)
  (setq ls-lisp-use-insert-directory-program nil)
  )

;;以 y/n 替代 yes/no
(fset 'yes-or-no-p 'y-or-n-p)
;; recent file，最近打开的文件，在menu上会出现一个最近打开的文件列表，
;; 当在c-x c-f打开文件时，M-p可以查看填入最近打开的文件，M-n可以恢复正常
(recentf-mode t)
;;显示行号
(global-linum-mode 1)
(column-number-mode t)
;;全屏，在使用railwaycat的emacs编译版本时，最大化按钮不是全屏
(global-set-key  [(M return)] 'toggle-frame-fullscreen)

;; 窗口间方便跳转
(global-set-key [M-left] 'windmove-left)
(global-set-key [M-right] 'windmove-right)
(global-set-key [M-up] 'windmove-up)
(global-set-key [M-down] 'windmove-down)

;; 这个插件很厉害，可以得到环境变量的值, 它会自动复制MANPATH, PATH and exec-path，
;; 其它的要通过(exec-path-from-shell-copy-env "GOPATH")的方式来设置
(when (memq window-system '(mac ns))
  (exec-path-from-shell-initialize))
(exec-path-from-shell-copy-env "GOPATH")

;; ////////////////common setting/////////////////



;; ///////////////programe setting ///////////////
(add-hook 'after-init-hook 'global-company-mode)
(require 'yasnippet)
(add-to-list 'yas-snippet-dirs "~/workspace/emacs24/snippets")
(setq yas/prompt-functions '(yas/dropdown-prompt))
(yas-global-mode 1)


;; google c++ style 检查
(add-to-list 'auto-mode-alist '("\\.h\\'" . c++-mode))
(add-hook 'c-mode-common-hook 'google-set-c-style)
(add-hook 'c-mode-common-hook 'google-make-newline-indent)

(add-hook 'c-mode-common-hook 'cscope-minor-mode)
;; 当开启semantic时，speedbar第一次展开一个文件的方法时会出错，这时只要重启关闭后再展示就正常了
(add-hook 'c-mode-common-hook 'semantic-mode)

;; flycheck 设置
(add-hook 'c++-mode-hook
	  (lambda () (setq flycheck-clang-language-standard "c++11")))
(setq flycheck-clang-include-path
      (list (expand-file-name "~/workspace/")
	    (expand-file-name "~/workspace/flygame/src/")
	    (expand-file-name "~/workspace/saf/")
	    (expand-file-name "../")
	    (expand-file-name "../../")
	    ))
(add-hook 'c-mode-common-hook 'flycheck-mode)
(add-hook 'go-mode-hook 'flycheck-mode)

;; cpplint
;; flycheck, 其中cppcheck默认就会调用cpplint,需要下载cpplint.py脚本
;; https://github.com/google/styleguide.git，这里可以找到
(require 'flycheck-google-cpplint)
(flycheck-add-next-checker 'c/c++-cppcheck
			   '(warning . c/c++-googlelint))

;; golang 设置
;; go语言自动补全,https://github.com/nsf/gocode，要去下载后端
(add-hook 'before-save-hook 'gofmt-before-save)
(defun my-go-mode-hook ()
    (push 'company-go company-backends))
(add-hook 'go-mode-hook 'my-go-mode-hook)


(add-hook 'c-mode-hook 'hs-minor-mode)
(add-hook 'c++-mode-hook 'hs-minor-mode)
(add-hook 'go-mode-hook 'hs-minor-mode)
(global-set-key (kbd "C-=") 'hs-show-block)
(global-set-key (kbd "C--") 'hs-hide-block)

;; sr-speedbar
(require 'sr-speedbar)
(speedbar-add-supported-extension ".go")

;; ecb-mode
(setq ecb-tip-of-the-day nil)
;; 可以点击操作
(setq ecb-primary-secondary-mouse-buttons (quote mouse-1--C-mouse-1))
;; 自带的布局http://ecb.sourceforge.net/docs/Changing-the-ECB-layout.html
(setq ecb-layout-name "left6")
;; 由于ecb在emacs25中c-x c-f 打开问题有bug，官方正在解决https://github.com/ecb-home/ecb/issues/10
;; 不过当打开ivy-mode时，可以正常操作
;; (ivy-mode t)
;; Disable buckets so that history buffer can display more entries
(setq ecb-history-make-buckets 'never)
(global-set-key (kbd "C-c C-e") 'ecb-minor-mode)

;; swiper 查找文件时可以预览，可以通过c-n c-p进行前后查找，这样就不用c-r的反向查找功能了
(global-set-key "\C-s" 'swiper)
(global-set-key "\C-r" 'swiper)


;; autopair mode
(autopair-global-mode)

;; org 自动换行
(add-hook 'org-mode-hook 
(lambda () (setq truncate-lines nil)))
;;org 代码高亮
(setq org-src-fontify-natively t)
(setq org-src-tab-acts-natively t)
(setq org-image-actual-width '(300 500))
;; 禁用下划线转义,org导出时下划线的问题abc_def中的def会变成小标
(setq org-use-sub-superscripts nil)
(setq org-export-with-sub-superscripts nil)


;; 代码注释
(defun qiang-comment-dwim-line (&optional arg)
  (interactive "*P")
  (comment-normalize-vars)
  (if (and (not (region-active-p)) (not (looking-at "[ \t]*$")))
      (comment-or-uncomment-region (line-beginning-position) (line-end-position))
    (comment-dwim arg)))
(global-set-key "\M-;" 'qiang-comment-dwim-line)


;; markdown
(setq markdown-command "/usr/local/bin/pandoc --from markdown_github-ascii_identifiers -t html5 --toc --number-sections --mathjax --highlight-style pygments --standalone")

;; ///////////////programe setting ///////////////



;; //////////// Other ///////////////

;; 编译远程文件
(setq tramp-default-method "ssh")
(setq tramp-default-user "sails")

;; wordpress
(setq org2blog/wp-blog-alist
      '(("sailsxu"
         :url "http://www.sailsxu.com/xmlrpc.php"
         :username "sailsxu"
         :default-categories ("c++")
         :keep-new-lines t
         :confirm t
         :wp-code nil
         :tags-as-categories nil)
	("clisp"
	 :url "http://www.clisp.net/xmlrpc.php"
         :username "sailsxu"
         :default-categories ("c++")
         :keep-new-lines t
         :confirm t
         :wp-code nil
         :tags-as-categories nil)
        ))

;; //////////// Other ///////////////

(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(ecb-options-version "2.50")
 '(scroll-bar-mode nil)
 '(tool-bar-mode nil))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )
