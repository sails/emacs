(require 'package)
;; 国内的镜像
;;(add-to-list 'package-archives
;;             '("melpa" . "https://melpa.org/packages/"))
(setq package-archives '(
			 ("gnu"   . "http://elpa.emacs-china.org/gnu/")
			 ("melpa" . "http://elpa.emacs-china.org/melpa/")))
(package-initialize)

(add-to-list 'load-path "~/.emacs.d/lisp/")

;; common lisp extensions一些额外的函数和宏
(require 'cl)
(eval-when-compile (require 'cl))

;; 启动自动检查安装配置
(defvar required-packages
  '(
    company
    yasnippet    
    flycheck
    projectile
    magit
    autopair
    ecb
    company-go
    org2blog
    markdown-mode
    json-mode
    sr-speedbar
    exec-path-from-shell
    multi-term
    google-c-style
    flymake-google-cpplint
    ggtags
    firestarter
    swiper
    ivy
    edit-at-point
    urlenc
    reveal-in-osx-finder
  ) "a list of packages to ensure are installed at launch.")

(defun packages-installed-p ()
  (loop for p in required-packages
        when (not (package-installed-p p)) do (return nil)
        finally (return t)))
;; 依次查检进行安装
(unless (packages-installed-p)
  (message "%s" "Emacs is now refreshing its package database...")
  (package-refresh-contents)
  (message "%s" " done.")
  ; install the missing packages
  (dolist (p required-packages)
    (when (not (package-installed-p p))
      (package-install p))))



;; ////////////////common setting/////////////////
;; key bindings,把meta映射成cmd键，但是不影响cmd+tab这样的系统快捷方式
;; emacs-mac-port 已经把meta改过了
(when (eq system-type 'darwin) ;; mac specific settings
  (message "remap key")
  (setq mac-option-modifier 'alt)
  (setq mac-command-modifier 'meta)
  (global-set-key [kp-delete] 'delete-char) ;; sets fn-delete to be right-delete
  ;; 由于ls与linux中的不同，有些插件可能会报错
  (require 'ls-lisp)
  (setq ls-lisp-use-insert-directory-program nil)
  )


;;以 y/n 替代 yes/no
(fset 'yes-or-no-p 'y-or-n-p)
;; recent file，最近打开的文件，在menu上会出现一个最近打开的文件列表，
;; 当在c-x c-f打开文件时，M-p可以查看填入最近打开的文件，M-n可以恢复正常
(recentf-mode t)
(set-frame-font "monaco-12")
;;(set-fontset-font t 'han (font-spec :family "monaco" :size 12))
;;显示行号
(global-linum-mode 1)
(column-number-mode t)
;;全屏，在使用railwaycat的emacs编译版本时，最大化按钮不是全屏
(global-set-key  [(M return)] 'toggle-frame-fullscreen)

;; 窗口间方便跳转
(global-set-key [M-left] 'windmove-left)
(global-set-key [M-right] 'windmove-right)
(global-set-key [M-up] 'windmove-up)
(global-set-key [M-down] 'windmove-down)

;; 这个插件很厉害，可以得到环境变量的值, 它会自动复制MANPATH, PATH and exec-path，
;; 其它的要通过(exec-path-from-shell-copy-env "GOPATH")的方式来设置
(when (memq window-system '(mac ns))
  (exec-path-from-shell-initialize))
(exec-path-from-shell-copy-env "GOPATH")

(require 'multi-term)
(setq multi-term-program "/bin/bash")

;; gtags默认把.h文件当成c语言的处理
(setenv "GTAGSFORCECPP" "1")
(add-hook 'c++-mode-hook
	  (lambda ()
        (ggtags-mode 1)
	    ))

;; 调用reveal-in-osx-finder在finder中打开当前目录，并选中当前文件
(require 'reveal-in-osx-finder)



;; ////////////////common setting/////////////////



;; ///////////////programe setting ///////////////

(require 'init-jce)

(add-hook 'after-init-hook 'global-company-mode)
;; any-company mode 默认是M-n M-p用于选择，但是习惯
(with-eval-after-load 'company
  (define-key company-active-map (kbd "M-n") nil)
  (define-key company-active-map (kbd "M-p") nil)
  (define-key company-active-map (kbd "C-n") #'company-select-next)
  (define-key company-active-map (kbd "C-p") #'company-select-previous)
  (setq company-idle-delay 0)

  ;; company-yasnippet会造成在以.开始的补全中，出现很多无用的运算符号
  (add-to-list
   'company-backends '(company-gtags))
;;  (add-to-list
;;   'company-backends '(company-gtags))
  (setq company-idle-delay 0.15)
  
  ;; 由于开启semantic-mode后,company-semantic 代替company-clang，它的优先级更高
  (setq company-backends (delete 'company-semantic company-backends))
  )

(require 'yasnippet)
(add-to-list 'yas-snippet-dirs "~/workspace/emacs/snippets")
(setq yas/prompt-functions '(yas/dropdown-prompt))
(yas-global-mode 1)

(add-to-list 'auto-mode-alist '("\\.h\\'" . c++-mode))

;; 基于google style修改编程风格
(c-add-style "Google" google-c-style)
(c-add-style "mine" '("Google"
                      (c-basic-offset . 4)
                      (c-offsets-alist . ((innamespace . 0)
                                          (access-label . -)
                                          (case-label . 0)
                                          (member-init-intro . +)
                                          (topmost-intro . 0)
                                          ))))

(defun my-c-common-hook()
       (progn
         (c-set-style "mine")
         )
       )

(add-hook 'c-mode-common-hook 'my-c-common-hook)
(add-hook 'c-mode-common-hook 'google-make-newline-indent)
(setq default-tab-width 4)
(setq-default indent-tabs-mode nil)


;; 当开启semantic时，speedbar第一次展开一个文件的方法时会出错，这时只要重启关闭后再展示就正常了
;; (add-hook 'c-mode-common-hook 'semantic-mode)

(setq flycheck-clang-include-path
      (list (expand-file-name "~/workspace/")
	    (expand-file-name "~/workspace/flygame/src/")
	    (expand-file-name "~/workspace/saf/")
	    (expand-file-name "~/workspace/vas_lib_proj/")
	    (expand-file-name "./")
	    (expand-file-name "../")
	    (expand-file-name "../../")

	    ))

(add-hook 'c++-mode-hook
	  (lambda ()
        ;; flycheck 设置
        (flycheck-mode 1)
	    (setq flycheck-clang-language-standard "c++11")
	    (flycheck-select-checker 'c/c++-cppcheck)
	    (setq flycheck-cppcheck-checks (quote ("style" "all")))
	    ))

(add-hook 'go-mode-hook 'flycheck-mode)


;; flymake
(defun my-flymake-google-init ()
  (require 'flymake-google-cpplint)
  (custom-set-variables
   ;; 如果不设置verbose选项，filter不生效
   '(flymake-google-cpplint-verbose "--verbose=0")
   ;; 默认是在当前目录，它有时会生成flymake.h/cpp结尾的临时文件，影响项目
   '(flymake-google-cpplint-location 'tempdir)
   '(flymake-google-cpplint-filter "--filter=-whitespace/braces,-build/include,-whitespace/line_length,-runtime/references")
   )
  (flymake-google-cpplint-load)
  )
;; (add-hook 'c-mode-hook 'my-flymake-google-init)
;; (add-hook 'c++-mode-hook 'my-flymake-google-init)


;; firestarter，用于设置每次保存时执行的命令
(firestarter-mode)

;; golang 设置
;; go语言自动补全,https://github.com/nsf/gocode，要去下载后端
(add-hook 'before-save-hook 'gofmt-before-save)
(defun my-go-mode-hook ()
    (push 'company-go company-backends))
(add-hook 'go-mode-hook 'my-go-mode-hook)


(add-hook 'c-mode-hook 'hs-minor-mode)
(add-hook 'c++-mode-hook 'hs-minor-mode)
(add-hook 'go-mode-hook 'hs-minor-mode)
(global-set-key (kbd "C-=") 'hs-show-block)
(global-set-key (kbd "C--") 'hs-hide-block)

;; sr-speedbar
(require 'sr-speedbar)
(setq sr-speedbar-right-side nil)
(speedbar-add-supported-extension ".go")
(speedbar-add-supported-extension ".proto")
(speedbar-add-supported-extension ".jce")
(setq speedbar-use-images nil)

;; ecb-mode
(require 'ecb)
;; 由于ecb在emacs25中c-x c-f 打开问题有bug，官方正在解决https://github.com/ecb-home/ecb/issues/10
(defun display-buffer-at-bottom--display-buffer-at-bottom-around (orig-fun &rest args)
  "Bugfix for ECB: cannot use display-buffer-at-bottom', calldisplay-buffer-use-some-window' instead in ECB frame."
  (if (and ecb-minor-mode (equal (selected-frame) ecb-frame))
      (apply 'display-buffer-use-some-window args)
    (apply orig-fun args)))
(advice-add 'display-buffer-at-bottom :around #'display-buffer-at-bottom--display-buffer-at-bottom-around)

(setq ecb-tip-of-the-day nil)

;; 可以点击操作
(setq ecb-primary-secondary-mouse-buttons (quote mouse-1--C-mouse-1))
;; 自带的布局http://ecb.sourceforge.net/docs/Changing-the-ECB-layout.html
;; (setq ecb-layout-name "left6")
(setq ecb-history-make-buckets 'never)
(global-set-key (kbd "C-c C-e") 'ecb-minor-mode)


;; swiper 查找文件时可以预览，可以通过c-n c-p进行前后查找，这样就不用c-r的反向查找功能了
;; (global-set-key "\C-s" 'swiper)
;; (global-set-key "\C-r" 'swiper)

;; ivy
(ivy-mode 1)


(projectile-global-mode)
(setq projectile-enable-caching t)
;; 默认它的find file是用外部的svn git命令来查找，但是如果有submodule时，所导致不多个project，而不是
;; 一个。如果设置native时，会直接遍历目录，所以会慢很多，基本上不能接受。所以还是用svn，git来查找，只是
;; 查找时，用c-c p F来，这样就是从已知的project中找查
;; (setq projectile-indexing-method 'native)
;; autopair mode
(autopair-global-mode)

;; 可以很方便的在头文件与cpp文件中切换
(setq cc-other-file-alist
      '(("\\.c"   (".h"))
        ("\\.cpp"   (".h"))
        ("\\.h"   (".c"".cpp"))))
(setq ff-search-directories
      '("." "../src" "../include"))
(add-hook 'c-mode-common-hook
          (lambda() 
            (local-set-key  (kbd "C-c o") 'ff-find-other-file)))

;; org 自动换行
(add-hook 'org-mode-hook 
(lambda () (setq truncate-lines nil)))
;;org 代码高亮
(setq org-src-fontify-natively t)
(setq org-src-tab-acts-natively t)
(setq org-image-actual-width '(300 500))
;; 禁用下划线转义,org导出时下划线的问题abc_def中的def会变成小标
(setq org-use-sub-superscripts nil)
(setq org-export-with-sub-superscripts nil)


;; 代码注释
(defun qiang-comment-dwim-line (&optional arg)
  (interactive "*P")
  (comment-normalize-vars)
  (if (and (not (region-active-p)) (not (looking-at "[ \t]*$")))
      (comment-or-uncomment-region (line-beginning-position) (line-end-position))
    (comment-dwim arg)))
(global-set-key "\M-;" 'qiang-comment-dwim-line)

;; markdown
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(column-number-mode t)
 '(custom-safe-themes
   (quote
    ("67e998c3c23fe24ed0fb92b9de75011b92f35d3e89344157ae0d544d50a63a72" default)))
 '(ecb-options-version "2.50")
 '(flymake-google-cpplint-filter
   "--filter=-whitespace/braces,-build/include,-whitespace/line_length,-runtime/references")
 '(flymake-google-cpplint-location (quote tempdir))
 '(flymake-google-cpplint-verbose "--verbose=0")
 '(package-selected-packages
   (quote
    (reveal-in-osx-finder smex urlenc edit-at-point quickrun zenburn-theme yasnippet xcscope swiper sr-speedbar psvn projectile org2blog neotree multi-term markdown-mode magit json-mode helm-gtags google-c-style ggtags flymake-google-cpplint firestarter exec-path-from-shell ecb company-irony company-go autopair)))
 '(safe-local-variable-values
   (quote
    ((firestarter . "rsync -avzP --password-file=/Users/sailsxu/Applications/password/rsync.password --timeout=2 --exclude='.svn'  --exclude='GPATH' --exclude='GRTAGS' --exclude='GTAGS'  /Users/sailsxu/workspace/dev_team_two_proj root@10.12.67.90::sailsxu")
     (firestarter . "rsync -avzP --password-file=/Users/sailsxu/Applications/password/rsync.password --timeout=2 --exclude='.svn'  --exclude='GPATH' --exclude='GRTAGS' --exclude='GTAGS'  /Users/sailsxu/workspace/vas_lib_proj root@10.12.67.90::sailsxu"))))
 '(scroll-bar-mode nil)
 '(tool-bar-mode nil))


;; ///////////////programe setting ///////////////



;; //////////// Other ///////////////

;; 复制，粘贴
(global-set-key (kbd "C-c e") 'edit-at-point-symbol-copy)
(global-set-key (kbd "C-c w") 'edit-at-point-word-copy)



;;(setq gdb-many-windows t)

;; 编译远程文件
(setq tramp-default-method "ssh")
(setq tramp-default-user "sailsxu")
;;(setq tramp-default-method "rsync")
;;(setq tramp-default-user "root")



;; wordpress
(setq org2blog/wp-blog-alist
      '(("sailsxu"
         :url "http://www.sailsxu.com/xmlrpc.php"
         :username "sailsxu"
         :default-categories ("c++")
         :keep-new-lines t
         :confirm t
         :wp-code nil
         :tags-as-categories nil)
	("clisp"
	 :url "http://www.clisp.net/xmlrpc.php"
         :username "sailsxu"
         :default-categories ("c++")
         :keep-new-lines t
         :confirm t
         :wp-code nil
         :tags-as-categories nil)
        ))


;; (add-hook 'LaTeX-mode-hook (lambda()
;;                              (add-to-list 'TeX-command-list '("XeLaTeX" "xelatex %(mode) %t" TeX-run-TeX nil  (latex-mode) ))
;; 			     (setq TeX-command-default "XeLaTeX")
;; 			     (setq TeX-save-query  nil )
;; 			     (setq TeX-show-compilation t)
;; 			     (setq TeX-PDF-mode t)
;; 			     ))

;; //////////// Other ///////////////



(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )
